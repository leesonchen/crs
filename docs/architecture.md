# Claude Relay Service - 系统架构图

## 1. 系统整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户和客户端层                              │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ Claude Code │  │ Gemini CLI  │  │ Cherry      │  │ 其他客户端   │     │
│  │             │  │             │  │ Studio      │  │             │     │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │
│         │               │               │               │               │
│         └───────────────┼───────────────┼───────────────┘               │
│                         │                                               │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                             负载均衡层                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                      Nginx/Caddy 反向代理                        │  │
│  │  • SSL/TLS 加密支持                                               │  │
│  │  • 负载均衡和健康检查                                            │  │
│  │  • 静态资源缓存                                                  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                           应用服务层                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                    Node.js 应用服务器 (Express)                    │  │
│  │                                                                   │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │  │
│  │  │ 路由层      │ │ 中间件层    │ │ 服务层      │ │ 数据层      │    │  │
│  │  │ (Routes)    │ │ (Middleware)│ │ (Services)  │ │ (Models)    │    │  │
│  │  │             │ │             │ │             │ │             │    │  │
│  │  │ • /api      │ │ • 认证      │ │ • 账户管理  │ │ • Redis     │    │  │
│  │  │ • /claude   │ │ • 授权      │ │ • 中继服务  │ │ • 文件系统  │    │  │
│  │  │ • /gemini   │ │ • 缓存      │ │ • 统计服务  │ │ • 外部API   │    │  │
│  │  │ • /openai   │ │ • 日志      │ │ • 价格计算  │ │             │    │  │
│  │  │ • /azure    │ │ • 监控      │ │ • 用户管理  │ │             │    │  │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                            数据存储层                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                             Redis 集群                              │  │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │  │
│  │  │ API Key     │ │ 使用统计    │ │ 账户信息    │ │ 会话状态    │    │  │
│  │  │ 存储        │ │ 数据        │ │ 存储        │ │ 缓存        │    │  │
│  │  │             │ │             │ │             │ │             │    │  │
│  │  │ • 密钥哈希  │ │ • 实时统计  │ │ • OAuth    │ │ • Sticky    │    │  │
│  │  │ • 权限配置  │ │ • 历史数据  │ │   凭据      │ │   Session   │    │  │
│  │  │ • 使用限制  │ │ • 费用计算  │ │ • 模型支持  │ │ • TTL管理   │    │  │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                          外部服务集成层                               │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ Claude API  │ │ Bedrock API │ │ Gemini API  │ │ OpenAI API  │        │
│  │             │ │             │ │             │ │             │        │
│  │ • OAuth认证 │ │ • AWS凭据   │ │ • API Key   │ │ • API Key   │        │
│  │ • 多账户    │ │ • 多区域    │ │ • 多模型    │ │ • 兼容接口  │        │
│  │ • 负载均衡  │ │ • 负载均衡  │ │ • 负载均衡  │ │ • 负载均衡  │        │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2. 数据流图

### 2.1 API请求处理数据流

```
┌─────────────┐
│   客户端请求  │ ────────────────────────────────┐
│   (Claude    │                                │
│    Code/Gemini│                                │
│    CLI等)     │                                │
└─────────────┘                                │
         │                                      │
         ▼                                      │
┌─────────────┐                                 │
│  负载均衡器  │                                │
│  (Nginx/     │                                │
│   Caddy)     │                                │
└─────────────┘                                 │
         │                                      │
         ▼                                      │
┌─────────────┐    ┌─────────────────────────┐  │
│  应用服务器  │    │    外部AI服务提供商     │  │
│  (Node.js)   │    │                         │  │
│              │    │  ┌─────────────┐        │  │
│  ┌─────────┐ │    │  │ Claude API  │        │  │
│  │  认证   │◄┼────┼─►│ Bedrock API │        │  │
│  │ 中间件  │ │    │  │ Gemini API  │        │  │
│  └─────────┘ │    │  │ OpenAI API  │        │  │
│              │    │  └─────────────┘        │  │
│  ┌─────────┐ │    └─────────────────────────┘  │
│  │  路由   │ │                                 │
│  │  处理   │ │                                 │
│  └─────────┘ │                                 │
│              │                                 │
│  ┌─────────┐ │                                 │
│  │  服务   │ │                                 │
│  │  层处   │ │                                 │
│  │   理    │ │                                 │
│  └─────────┘ │                                 │
│              │                                 │
│  ┌─────────┐ │                                 │
│  │  统计   │◄┼─────────────────────────────────┘
│  │  更新   │ │
│  └─────────┘ │
│              │
│  ┌─────────┐ │
│  │  缓存   │◄┼─────────────────────────────────┐
│  │  同步   │ │                                │
│  └─────────┘ │                                │
│              │                                │
└─────────────┘                                │
         │                                      │
         ▼                                      │
┌─────────────┐                                 │
│   Redis     │                                 │
│   集群      │                                 │
│             │                                 │
│  ┌─────────┐ │                                 │
│  │ API Key │ │                                 │
│  │  验证   │ │                                 │
│  │ 缓存    │ │                                 │
│  └─────────┘ │                                 │
│             │                                 │
│  ┌─────────┐ │                                 │
│  │ 使用统  │ │                                 │
│  │  计数   │ │                                 │
│  │  据     │ │                                 │
│  └─────────┘ │                                 │
│             │                                 │
│  ┌─────────┐ │                                 │
│  │ 会话状  │ │                                 │
│  │  态     │ │                                 │
│  └─────────┘ │                                 │
└─────────────┘                                 │
```

### 2.2 统一调度数据流

```
┌─────────────┐
│   调度请求   │
│   进入       │
└─────────────┘
         │
         ▼
┌─────────────┐    ┌─────────────┐
│  解析请求   │───▶│  检查模型   │
│  参数       │    │   支持      │
│             │    │             │
│  • 模型     │    │  • 账户支持  │
│  • 会话Hash │    │  • 模型兼容  │
│  • API Key  │    │  • 限制检查  │
└─────────────┘    └─────────────┘
         │
         ▼
┌─────────────┐    ┌─────────────┐
│  优先级排队 │    │  健康检查   │
│             │    │             │
│  1. 健康+低负载  │    │  • API可用性 │
│  2. 健康+支持模型│    │  • 错误率   │
│  3. 健康账户    │    │  • 响应时间 │
│  4. 可恢复账户  │    └─────────────┘
│  5. 备用账户    │
└─────────────┘
         │
         ▼
┌─────────────┐    ┌─────────────┐
│  会话粘性   │    │  负载均衡   │
│  管理       │    │  算法       │
│             │    │             │
│  • Hash映射 │    │  • 轮询     │
│  • TTL管理  │    │  • 加权轮询 │
│  • 智能续期 │    │  • 最少连接 │
└─────────────┘    │  • 响应时间 │
         │         └─────────────┘
         ▼
┌─────────────┐
│  选择目标   │
│   账户      │
│             │
│  • 账户ID   │
│  • 账户类型 │
│  • 连接信息 │
└─────────────┘
         │
         ▼
┌─────────────┐    ┌─────────────┐
│  建立连接   │    │  执行请求   │
│             │    │             │
│  • 认证信息 │    │  • 转发请求  │
│  • 代理配置 │    │  • 流式处理  │
│  • 超时设置 │    │  • 错误处理  │
└─────────────┘    └─────────────┘
         │
         ▼
┌─────────────┐    ┌─────────────┐
│  响应处理   │    │  统计更新   │
│             │    │             │
│  • 流式响应 │    │  • Token使用 │
│  • 错误处理 │    │  • 费用计算 │
│  • 日志记录 │    │  • 性能指标 │
└─────────────┘    └─────────────┘
         │
         ▼
┌─────────────┐
│  完成响应   │
│   返回      │
└─────────────┘
```

### 2.3 缓存数据流

```
┌─────────────┐
│   缓存读取   │
└─────────────┘
         │
         ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  检查内存   │───▶│  检查Redis  │───▶│  检查源数据 │
│   缓存      │    │   缓存      │    │             │
└─────────────┘    └─────────────┘    └─────────────┘
         │               │               │
         │               │               │
         ▼               ▼               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  缓存命中   │    │  缓存命中   │    │  获取数据   │
│  (立即返回) │    │  (回写内存  │    │  (回写缓存) │
└─────────────┘    │   缓存)     │    └─────────────┘
         │         └─────────────┘         │
         ▼               │               │
┌─────────────┐         │               │
│  返回数据   │◄────────┘               │
└─────────────┘                         │
         │                               │
         ▼                               │
┌─────────────┐                         │
│   缓存失效   │                         │
│   通知       │                         │
└─────────────┘                         │
         │                               │
         ▼                               │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  发布订阅   │    │  清理内存   │    │  清理Redis  │
│  机制       │    │   缓存      │    │   缓存      │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 2.4 统计数据处理流

```
┌─────────────┐
│   API请求   │
│   完成       │
└─────────────┘
         │
         ▼
┌─────────────┐    ┌─────────────┐
│  解析响应   │    │  计算费用   │
│             │    │             │
│  • Token使用 │    │  • 输入Token │
│  • 模型信息 │    │  • 输出Token │
│  • 响应时间 │    │  • 缓存Token │
└─────────────┘    └─────────────┘
         │
         ▼
┌─────────────┐    ┌─────────────┐
│  构建统计   │    │  批量处理   │
│  数据       │    │  Pipeline   │
│             │    │             │
│  • API Key  │    │  • 实时统计  │
│  • 账户     │    │  • 每日统计  │
│  • 模型     │    │  • 每月统计  │
│  • 时间维   │    │  • 小时统计  │
│  • 费用     │    │  • 模型统计  │
└─────────────┘    └─────────────┘
         │
         ▼
┌─────────────┐    ┌─────────────┐
│  更新Redis  │    │  异步处理   │
│  统计数据   │    │  其他任务   │
│             │    │             │
│  • 原子操作 │    │  • 日志记录  │
│  • 过期设置 │    │  • 缓存清理  │
│  • 批量写入 │    │  • 通知服务  │
└─────────────┘    └─────────────┘
         │
         ▼
┌─────────────┐    ┌─────────────┐
│  实时指标   │    │  历史数据   │
│  更新       │    │  聚合       │
│             │    │             │
│  • 系统负载 │    │  • 趋势分析  │
│  • 性能指标 │    │  • 报表生成  │
│  • 健康状态 │    │  • 数据导出  │
└─────────────┘    └─────────────┘
```

## 3. 部署架构图

### 3.1 单实例部署

```
┌─────────────────────────────────────────────────────────────┐
│                     Docker 容器                             │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │               Node.js 应用服务器                     │    │
│  │                                                     │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │    │
│  │  │  Web    │ │ Admin   │ │  API    │ │ 服务   │      │    │
│  │  │ 界面    │ │ 面板    │ │ 路由    │ │ 层     │      │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │    │
│  │                                                     │    │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │    │
│  │  │ 中间件  │ │ 认证    │ │ 缓存    │ │ 日志    │      │    │
│  │  │ 层      │ │ 服务    │ │ 管理    │ │ 系统    │      │    │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │    │
│  │                                                     │    │
│  │  ┌─────────────────────────────────────────────────┐ │    │
│  │  │              统一调度器和服务集成                 │ │    │
│  │  │  Claude │ Bedrock │ Gemini │ OpenAI │ Azure     │ │    │
│  │  └─────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    Redis 数据库                      │    │
│  │  API Key │ 使用统计 │ 账户信息 │ 会话状态 │ 缓存     │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    文件系统                          │    │
│  │  配置 │ 日志 │ 统计数据 │ 临时文件 │ 静态资源         │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 集群部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    外部负载均衡器 (可选)                        │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐     │
│  │  LB-1   │ │  LB-2   │ │  LB-3   │ │  LB-4   │ │  LB-5   │     │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘     │
└─────────────────────────────────────────────────────────────────┘
               │                 │                 │
               ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                       应用服务器集群                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐      │
│  │   App Server    │ │   App Server    │ │   App Server    │      │
│  │     Node-1      │ │     Node-2      │ │     Node-3      │      │
│  │                 │ │                 │ │                 │      │
│  │  ┌─────────────┐ │ │  ┌─────────────┐ │ │  ┌─────────────┐ │      │
│  │  │  API处理    │ │ │  │  API处理    │ │ │  │  API处理    │ │      │
│  │  │  模块       │ │ │  │  模块       │ │ │  │  模块       │ │      │
│  │  └─────────────┘ │ │  └─────────────┘ │ │  └─────────────┘ │      │
│  │                 │ │                 │ │                 │      │
│  │  ┌─────────────┐ │ │  ┌─────────────┐ │ │  ┌─────────────┐ │      │
│  │  │  缓存同步    │ │ │  │  缓存同步    │ │ │  │  缓存同步    │ │      │
│  │  │  模块       │ │ │  │  模块       │ │ │  │  模块       │ │      │
│  │  └─────────────┘ │ │  └─────────────┘ │ │  └─────────────┘ │      │
│  │                 │ │                 │ │                 │      │
│  │  ┌─────────────┐ │ │  ┌─────────────┐ │ │  ┌─────────────┐ │      │
│  │  │  统计聚合    │ │ │  │  统计聚合    │ │ │  │  统计聚合    │ │      │
│  │  │  模块       │ │ │  │  模块       │ │ │  │  模块       │ │      │
│  │  └─────────────┘ │ │  └─────────────┘ │ │  └─────────────┘ │      │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
               │                 │                 │
               ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Redis 集群                                 │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐      │
│  │   Redis         │ │   Redis         │ │   Redis         │      │
│  │   Master-1      │ │   Master-2      │ │   Master-3      │      │
│  │                 │ │                 │ │                 │      │
│  │  ┌─────────────┐ │ │  ┌─────────────┐ │ │  ┌─────────────┐ │      │
│  │  │  API Key    │ │ │  │  使用统计   │ │ │  │  账户信息   │ │      │
│  │  │  存储       │ │ │  │  数据       │ │ │  │  存储       │ │      │
│  │  └─────────────┘ │ │  └─────────────┘ │ │  └─────────────┘ │      │
│  │                 │ │                 │ │                 │      │
│  │  ┌─────────────┐ │ │  ┌─────────────┐ │ │  ┌─────────────┐ │      │
│  │  │  复制数据    │ │ │  │  复制数据    │ │ │  │  复制数据    │ │      │
│  │  │  同步       │ │ │  │  同步       │ │ │  │  同步       │ │      │
│  │  └─────────────┘ │ │  └─────────────┘ │ │  └─────────────┘ │      │
│  │                 │ │                 │ │                 │      │
│  │  ┌─────────────┐ │ │  ┌─────────────┐ │ │  ┌─────────────┐ │      │
│  │  │  Slave-1    │ │ │  │  Slave-1    │ │ │  │  Slave-1    │ │      │
│  │  │  (只读)     │ │ │  │  (只读)     │ │ │  │  (只读)     │ │      │
│  │  └─────────────┘ │ │  └─────────────┘ │ │  └─────────────┘ │      │
│  │                 │ │                 │ │                 │      │
│  │  ┌─────────────┐ │ │  ┌─────────────┐ │ │  ┌─────────────┐ │      │
│  │  │  Slave-2    │ │ │  │  Slave-2    │ │ │  │  Slave-2    │ │      │
│  │  │  (只读)     │ │ │  │  (只读)     │ │ │  │  (只读)     │ │      │
│  │  └─────────────┘ │ │  └─────────────┘ │ │  └─────────────┘ │      │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

## 4. 组件交互图

### 4.1 内部组件交互

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   客户端     │───▶│  路由处理   │───▶│  认证中间件 │───▶│  业务服务   │
│   请求       │    │   器       │    │             │    │   层       │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
         │               │               │               │
         ▼               ▼               ▼               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   负载       │    │   缓存      │    │  统一调度   │    │   外部     │
│   均衡器     │    │   管理器    │    │   器       │    │   服务     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
         │               │               │               │
         ▼               ▼               ▼               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Redis     │◄───│   日志     │◄───│   统计     │◄───│   响应     │
│   集群      │    │   系统     │    │   服务     │    │   处理     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

### 4.2 外部服务集成

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Claude Relay Service                         │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │
│  │ 账户管理    │ │ 中继服务    │ │ 统计服务    │ │ 缓存服务    │     │
│  │ 服务        │ │             │ │             │ │             │     │
│  │             │ │  ┌─────────┐ │ │  ┌─────────┐ │ │  ┌─────────┐ │     │
│  │  • OAuth    │ │  │ Claude  │ │ │  │ 使用统  │ │ │  │ Redis   │ │     │
│  │  • 账户轮换 │ │  │ Relay   │ │ │  │ 计记录  │ │ │  │ 缓存    │ │     │
│  │  • 健康检查 │ │  │ Service │ │ │  │         │ │ │  │         │ │     │
│  │             │ │  └─────────┘ │ │  └─────────┘ │ │  └─────────┘ │     │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │
│         │               │               │               │            │
│         └───────────────┼───────────────┼───────────────┘            │
│                         │               │                           │
│         ┌───────────────┼───────────────┼───────────────┐           │
│         │               │               │               │           │
│  ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐   │
│  │ Claude API  │ │ Bedrock API │ │ Gemini API  │ │ OpenAI API  │   │
│  │             │ │             │ │             │ │             │   │
│  │  • OAuth    │ │  • AWS      │ │  • Google    │ │  • API Key   │   │
│  │  • API Key  │ │    凭据     │ │    API Key   │ │             │   │
│  │  • 模型支持  │ │  • 区域支持 │ │  • 模型支持  │ │  • 模型兼容  │   │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

## 5. 数据存储架构

### 5.1 Redis数据结构设计

```
Redis 数据库
├── API Key 存储区
│   ├── apikey:{keyId}                    → Hash (API密钥信息)
│   ├── apikey:hash_map                   → Hash (哈希到KeyId映射)
│   └── apikey_hash:{hashedKey}           → Hash (哈希密钥详情)
│
├── 使用统计存储区
│   ├── usage:{keyId}                     → Hash (总使用统计)
│   ├── usage:daily:{keyId}:{date}        → Hash (每日统计)
│   ├── usage:monthly:{keyId}:{month}      → Hash (每月统计)
│   ├── usage:hourly:{keyId}:{hour}        → Hash (每小时统计)
│   ├── usage:records:{keyId}             → List (使用记录)
│   ├── usage:cost:daily:{keyId}:{date}   → String (每日费用)
│   ├── usage:cost:total:{keyId}          → String (总费用)
│   └── usage:opus:weekly:{keyId}:{week}  → String (周Opus费用)
│
├── 账户存储区
│   ├── claude:account:{accountId}        → Hash (Claude账户)
│   ├── openai:account:{accountId}         → Hash (OpenAI账户)
│   ├── bedrock:account:{accountId}        → Hash (Bedrock账户)
│   └── account_usage:{accountId}          → Hash (账户使用统计)
│
├── 会话管理区
│   ├── session:{sessionId}                → Hash (会话信息)
│   ├── oauth:{sessionId}                  → Hash (OAuth会话)
│   ├── sticky_session:{sessionHash}      → String (粘性会话映射)
│   └── concurrency:{keyId}               → String (并发计数)
│
├── 缓存存储区
│   ├── cache:account:{accountId}          → Hash (账户缓存)
│   ├── cache:pricing:{model}              → String (价格缓存)
│   └── cache:stats:{key}                  → String (统计缓存)
│
├── 系统配置区
│   ├── config:{key}                       → String (系统配置)
│   ├── system:metrics:minute:{timestamp}  → Hash (分钟指标)
│   └── health:status                       → Hash (健康状态)
│
└── 临时数据区
    ├── temp:{key}                         → String (临时数据)
    ├── lock:{lockKey}                     → String (分布式锁)
    └── queue:{queueName}                  → List (队列数据)
```

### 5.2 数据流转图

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   API请求   │───▶│  解析请求   │───▶│  验证认证   │───▶│  选择账户   │
│   处理      │    │   参数     │    │   信息     │    │   目标     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
         │               │               │               │
         ▼               ▼               ▼               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   内存缓存   │    │   Redis     │    │   外部     │    │   统计     │
│   检查      │    │   缓存      │    │   服务     │    │   计算     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
         │               │               │               │
         ▼               ▼               ▼               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   缓存命中   │    │   缓存更新   │    │   响应     │    │   数据     │
│   返回      │    │   策略     │    │   处理     │    │   持久化   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
         │               │               │               │
         ▼               ▼               ▼               ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   源数据    │    │   缓存失效   │    │   错误     │    │   日志     │
│   获取      │    │   通知     │    │   处理     │    │   记录     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 6. 监控和告警架构

### 6.1 监控指标收集

```
┌─────────────────────────────────────────────────────────────────────┐
│                        监控数据收集系统                              │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │
│  │ 系统指标    │ │ 应用指标    │ │ 业务指标    │ │ 外部指标    │     │
│  │             │ │             │ │             │ │             │     │
│  │  • CPU使用率 │ │  • 请求率   │ │  • API使用  │ │  • 服务可用 │     │
│  │  • 内存使用 │ │  • 错误率   │ │  • Token使用 │ │  • 响应时间 │     │
│  │  • 磁盘使用 │ │  • 响应时间 │ │  • 费用统计 │ │  • 错误率   │     │
│  │  • 网络IO   │ │  • 并发数   │ │  • 账户健康 │ │             │     │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │
│         │               │               │               │            │
│         └───────────────┼───────────────┼───────────────┘            │
│                         │               │                           │
│         ┌───────────────┼───────────────┼───────────────┐           │
│         │               │               │               │           │
│  ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐   │
│  │ Prometheus  │ │  统计服务   │ │  日志系统   │ │  健康检查   │   │
│  │ 指标收集    │ │  聚合计算   │ │  结构化日志 │ │  端点       │   │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 告警规则配置

```
┌─────────────────────────────────────────────────────────────────────┐
│                        告警规则引擎                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐     │
│  │ 性能告警    │ │ 业务告警    │ │ 系统告警    │ │ 安全告警    │     │
│  │             │ │             │ │             │ │             │     │
│  │  • 高CPU    │ │  • API异常  │ │  • 内存不足 │ │  • 认证失败 │     │
│  │  • 高内存   │ │  • Token使用 │ │  • 磁盘满   │ │  • 异常访问 │     │
│  │  • 响应慢   │ │  • 账户异常 │ │  • 服务异常 │ │  • 攻击检测 │     │
│  │  • 错误率高 │ │  • 费用异常 │ │  • 网络异常 │ │             │     │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘     │
│         │               │               │               │            │
│         └───────────────┼───────────────┼───────────────┘            │
│                         │               │                           │
│         ┌───────────────┼───────────────┼───────────────┐           │
│         │               │               │               │           │
│  ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐   │
│  │ 邮件通知    │ │  微信通知   │ │  Webhook    │ │  控制台     │   │
│  │ 服务        │ │  服务       │ │  通知       │ │  告警       │   │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

## 7. 总结

这个架构设计充分考虑了：

1. **高可用性**: 多层负载均衡、故障转移、健康检查
2. **高性能**: 缓存优化、异步处理、批量操作
3. **可扩展性**: 模块化设计、插件机制、服务接口
4. **可维护性**: 清晰的分层、完善的日志、监控告警
5. **安全性**: 多重认证、访问控制、数据加密

整个系统能够支持从单实例部署到大规模集群部署的平滑扩展，满足不同规模用户的需求。

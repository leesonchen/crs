# Claude Relay Service - 产品需求文档 (PRD)

## 1. 项目概述

Claude Relay Service 是一个企业级的AI API中继服务，旨在为用户提供安全、稳定、高效的AI服务访问解决方案。通过自建服务，用户可以：

- 🔐 **隐私保护**: 避免第三方镜像服务记录对话内容
- ⚡ **性能优化**: 控制服务质量和响应速度
- 💰 **成本透明**: 清楚了解实际使用成本
- 📊 **监控完整**: 全面的使用统计和性能监控

## 2. 核心功能需求

### 2.1 多AI服务提供商支持

#### 2.1.1 Claude官方服务
- **OAuth认证**: 支持Claude官方OAuth授权流程
- **多账户轮换**: 自动在多个Claude账户间切换以提高可用性
- **智能负载均衡**: 基于账户状态和使用情况进行智能调度
- **会话粘性**: 同一会话请求始终路由到相同账户

#### 2.1.2 Claude Console服务
- **Console API**: 支持Claude Console的API接口
- **模型映射**: 支持Console特有的模型格式
- **账户管理**: 独立的Console账户管理

#### 2.1.3 Bedrock服务
- **AWS Bedrock**: 支持AWS Bedrock上的Claude模型
- **多区域支持**: 支持不同AWS区域的Bedrock服务
- **账户轮换**: Bedrock账户的负载均衡

#### 2.1.4 CCR (Claude Code Relay)服务
- **专用通道**: 为Claude Code提供专用的中继通道
- **模型兼容**: 支持Claude Code特有的模型标识

#### 2.1.5 OpenAI兼容服务
- **API兼容**: 提供OpenAI兼容的API接口
- **Gemini支持**: 支持Google Gemini模型
- **Azure OpenAI**: 支持Azure上的OpenAI服务

### 2.2 API密钥管理系统

#### 2.2.1 密钥创建和管理
- **密钥生成**: 自动生成安全的API密钥
- **权限控制**: 为每个密钥设置不同的权限和限制
- **生命周期管理**: 密钥创建、禁用、删除等生命周期管理

#### 2.2.2 使用限制
- **速率限制**: 基于请求次数和Token使用量的限制
- **并发限制**: 同时处理请求数量的限制
- **模型限制**: 可访问模型的限制（黑名单模式）
- **客户端限制**: 基于User-Agent的客户端访问控制

### 2.3 使用统计和费用计算

#### 2.3.1 多维度统计
- **实时统计**: 分钟级、小时级、日级、月级统计
- **账户统计**: 每个AI账户的使用情况统计
- **模型统计**: 按模型的使用统计
- **用户统计**: 按API密钥的用户使用统计

#### 2.3.2 费用计算
- **实时费用**: 基于实际Token使用量的费用计算
- **多币种支持**: 支持不同货币的费用显示
- **历史费用**: 费用历史的查询和导出

#### 2.3.3 数据存储
- **Redis存储**: 高效的内存数据库存储统计数据
- **数据持久化**: 定期将统计数据持久化到磁盘
- **数据清理**: 自动清理过期统计数据

### 2.4 Web管理界面

#### 2.4.1 用户认证
- **管理员登录**: 安全的管理员认证系统
- **会话管理**: 自动会话过期和续期
- **权限控制**: 基于角色的访问控制

#### 2.4.2 账户管理
- **Claude账户**: OAuth授权、账户状态监控
- **Console账户**: Console账户的添加和管理
- **Bedrock账户**: AWS凭据管理和区域配置
- **账户分组**: 支持将多个账户组织为逻辑分组

#### 2.4.3 API密钥管理
- **密钥列表**: 查看所有API密钥及其状态
- **密钥创建**: 创建新API密钥并配置限制
- **使用监控**: 实时查看密钥使用情况

#### 2.4.4 统计仪表板
- **实时指标**: 系统当前负载和性能指标
- **历史数据**: 历史使用情况的图表展示
- **费用分析**: 详细的费用分析和趋势图表

### 2.5 高可用性和容错

#### 2.5.1 负载均衡
- **智能调度**: 基于账户健康状态的智能调度
- **故障转移**: 自动切换到可用的备用账户
- **重试机制**: 失败请求的自动重试

#### 2.5.2 缓存系统
- **多级缓存**: 账户信息、配置数据的缓存
- **缓存失效**: 智能的缓存失效和更新机制
- **缓存监控**: 缓存命中率和性能监控

#### 2.5.3 监控告警
- **健康检查**: 系统各组件的健康状态检查
- **性能监控**: 响应时间、吞吐量等性能指标
- **异常告警**: 错误率、失败率等异常情况告警

## 3. 技术需求

### 3.1 后端技术栈
- **Node.js**: 18+版本
- **Express.js**: Web框架
- **Redis**: 数据存储和缓存
- **Winston**: 日志管理

### 3.2 前端技术栈
- **Vue.js 3**: 前端框架
- **Vite**: 构建工具
- **Tailwind CSS**: 样式框架
- **Chart.js**: 图表库

### 3.3 部署要求
- **Docker支持**: 完整的Docker部署方案
- **Linux支持**: 主要部署平台为Linux
- **代理支持**: HTTP/SOCKS5代理支持

## 4. 安全需求

### 4.1 认证安全
- **API密钥认证**: 安全的API密钥验证机制
- **哈希存储**: 敏感信息的安全哈希存储
- **传输加密**: HTTPS传输加密

### 4.2 访问控制
- **客户端限制**: 基于User-Agent的客户端访问控制
- **IP限制**: 可选的IP地址访问限制
- **速率限制**: 防止API滥用的速率限制

### 4.3 数据安全
- **敏感信息保护**: API密钥、账户凭据的加密存储
- **审计日志**: 所有操作的详细审计日志
- **数据备份**: 统计数据的定期备份

## 5. 性能需求

### 5.1 响应时间
- **API响应**: 99%的请求响应时间<2秒
- **管理界面**: 页面加载时间<3秒
- **统计查询**: 复杂查询响应时间<5秒

### 5.2 并发处理
- **同时请求**: 支持1000+并发请求
- **流式处理**: 流式响应的低延迟处理
- **会话管理**: 数万活跃会话的并发管理

### 5.3 数据处理
- **统计计算**: 实时统计数据的高效计算
- **缓存性能**: 缓存命中率>95%
- **存储性能**: Redis操作响应时间<10ms

## 6. 扩展性需求

### 6.1 水平扩展
- **多实例部署**: 支持多实例的水平扩展
- **负载均衡**: 实例间的负载均衡
- **数据同步**: 实例间的数据一致性保证

### 6.2 功能扩展
- **新AI服务**: 易于添加新的AI服务提供商
- **自定义插件**: 支持自定义处理插件
- **API扩展**: 易于添加新的API端点

## 7. 部署和运维需求

### 7.1 部署方案
- **Docker Compose**: 一键部署方案
- **脚本部署**: 自动化部署脚本
- **手动部署**: 详细的手动部署文档

### 7.2 监控运维
- **日志管理**: 结构化日志和日志轮转
- **健康检查**: 完整的健康检查端点
- **指标暴露**: Prometheus兼容的指标暴露

### 7.3 备份恢复
- **配置备份**: 配置文件和密钥的备份
- **数据备份**: 统计数据的导出和导入
- **灾难恢复**: 完整的灾难恢复方案

## 8. 用户体验需求

### 8.1 易用性
- **快速上手**: 15分钟内完成部署和配置
- **友好界面**: 直观的管理界面设计
- **详细文档**: 完整的使用文档和FAQ

### 8.2 兼容性
- **多客户端支持**: 支持Claude Code、Gemini CLI等多种客户端
- **API兼容**: 与主流AI客户端的API兼容
- **迁移便利**: 从其他服务迁移的便利性

## 9. 合规和法律需求

### 9.1 隐私合规
- **数据最小化**: 只存储必要的使用统计数据
- **用户控制**: 用户对其数据的完全控制权
- **透明度**: 清晰的数据处理和存储政策

### 9.2 服务条款
- **使用限制**: 遵守各AI服务提供商的服务条款
- **免责声明**: 清晰的使用风险说明
- **合规检查**: 定期检查合规性要求

## 10. 未来规划

### 10.1 短期目标 (3-6个月)
- 完善多语言支持
- 添加更多AI服务集成
- 优化性能和稳定性

### 10.2 中期目标 (6-12个月)
- 企业级功能增强
- API管理平台
- 高级分析功能

### 10.3 长期目标 (1-2年)
- 商业化服务
- 插件生态系统
- 国际化部署
